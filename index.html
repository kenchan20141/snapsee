<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>拍圖查詢</title>
<link rel="manifest" href="manifest.json">
<meta name="description" content="專為長者設計的圖像查詢工具，拍下照片，立即知道它是什麼。">

<!-- 引入字體 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">


<style>
/* --- 版權信息 --- */
.copyright-footer {
position: fixed;
bottom: 0;
right: 0;
padding: 5px 10px;
background-color: #f1f1f1;
}

.copyright-footer p {
margin: 0;
font-size: 14px;
}

@media (max-width: 600px) {
.copyright-footer p {
font-size: 12px;
}
}

/* --- 整體風格與顏色 --- */
:root {
--bg-color: #F5F3EF;
--text-color: #2E2B26;
--accent-color: #5C4033;
--border-color: #A9A191;
--font-main: 'Noto Serif TC', serif;
}

body {
font-family: var(--font-main);
background-color: var(--bg-color);
color: var(--text-color);
display: flex;
flex-direction: column;
align-items: center;
justify-content: flex-start;
min-height: 100vh;
margin: 0;
padding: 2rem;
box-sizing: border-box;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

#container {
width: 100%;
max-width: 650px;
background: rgba(255, 255, 255, 0.3);
padding: 2.5rem;
border: 1px solid var(--border-color);
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
text-align: center;
transition: all 0.5s ease;
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
margin-top: 2rem;
}

/* --- 標題與說明文字 --- */
h1 {
font-size: 3.5rem;
font-weight: 700;
letter-spacing: 0.1em;
margin: 0 0 1rem 0;
color: var(--text-color);
}

#subtitle {
font-size: 1.5rem;
color: var(--accent-color);
margin-bottom: 2.5rem;
line-height: 1.6;
}

/* --- 圖片上傳區域 --- */
#image-input-area {
position: relative;
width: 100%;
min-height: 250px;
border: 3px dashed var(--border-color);
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
cursor: pointer;
transition: all 0.3s ease;
overflow: hidden;
box-sizing: border-box;
}

#image-input-area.has-image {
min-height: 0;
border: 2px solid var(--border-color);
background: none;
}

#image-preview {
display: none;
width: 100%;
height: auto;
}

#upload-prompt {
padding: 1rem;
transition: opacity 0.5s ease;
font-size: 2rem;
color: var(--accent-color);
}

.upload-icon {
width: 50px;
height: 50px;
margin-bottom: 1rem;
color: var(--accent-color);
}

#file-input, #camera-input {
display: none;
}

/* --- 操作按鈕 --- */
#action-buttons {
display: flex;
justify-content: center;
flex-wrap: wrap;
gap: 1.5rem;
margin-top: 2rem;
}

.action-btn {
background: none;
border: 2px solid var(--border-color);
color: var(--accent-color);
padding: 18px 35px;
font-family: var(--font-main);
font-size: 1.8rem;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 1rem;
}

.action-btn:hover:not(:disabled) {
background-color: var(--bg-color);
border-color: var(--accent-color);
}

.action-btn:disabled {
cursor: not-allowed;
opacity: 0.6;
}

/* --- 全域自動播放開關 --- */
#autoplay-control-area {
margin-top: 2rem;
display: flex;
justify-content: center;
align-items: center;
}

#tts-toggle-container {
display: flex;
align-items: center;
gap: 0.75rem;
cursor: pointer;
user-select: none;
border: 2px solid var(--border-color);
padding: 10px 20px;
border-radius: 8px;
transition: all 0.3s ease;
background: none;
}
#tts-toggle-container:hover {
background-color: var(--bg-color);
}

#tts-toggle-container .tts-icon {
width: 28px;
height: 28px;
color: var(--accent-color);
position: relative;
}

.tts-icon svg {
position: absolute;
top: 0;
left: 0;
transition: opacity 0.3s ease;
}

#tts-status-text {
font-size: 1.5rem;
font-family: var(--font-main);
color: var(--text-color);
font-weight: bold;
}

#tts-autoplay-checkbox {
display: none;
}
#tts-autoplay-checkbox:not(:checked) ~ .tts-icon .speaker-on-icon { display: none; }
#tts-autoplay-checkbox:checked ~ .tts-icon .speaker-off-icon { display: none; }


/* --- 結果顯示區域 --- */
#result-container {
margin-top: 2.5rem;
width: 100%;
min-height: 100px;
padding-top: 2rem;
box-sizing: border-box;
border-top: 2px solid var(--border-color);
text-align: left;
opacity: 0;
transition: opacity 1.5s ease;
}

#result-container.visible {
opacity: 1;
}

#item-name-display {
font-size: 2.5rem;
font-weight: 700;
color: var(--text-color);
margin: 0 0 1.5rem 0; /* 維持與下方描述的間距 */
}

#description-container h4 {
font-size: 1.8rem;
font-weight: 700;
color: var(--text-color);
margin: 0 0 1rem 0;
}

#item-description-display {
font-size: 1.6rem;
line-height: 1.8;
color: var(--accent-color);
}

/* --- 播放控制器 (新位置) --- */
#tts-playback-controls {
display: flex;
justify-content: center;
align-items: center;
gap: 2rem;
margin-bottom: 2rem; /* 與下方標題的間距 */
}

.playback-btn {
background: none;
border: none;
cursor: pointer;
padding: 10px;
color: var(--accent-color);
transition: transform 0.2s ease, color 0.2s ease;
}

.playback-btn:hover {
color: var(--text-color);
transform: scale(1.1);
}

.playback-btn svg {
width: 48px; /* 顯眼的圖示尺寸 */
height: 48px;
stroke-width: 1.5;
}

#play-pause-btn .pause-icon { display: none; }
#play-pause-btn.is-playing .play-icon { display: none; }
#play-pause-btn.is-playing .pause-icon { display: block; }


/* --- Loading 狀態 --- */
#loading-indicator {
display: none;
width: 100%;
text-align: center;
padding: 2rem 0;
font-size: 1.5rem;
color: var(--accent-color);
}

/* --- 響應式設計 --- */
@media (max-width: 768px) {
body { padding: 1rem; }
#container { padding: 1.5rem; margin-top: 1rem; }
h1 { font-size: 2.5rem; }
#subtitle { font-size: 1.2rem; }
.action-btn { padding: 15px 25px; font-size: 1.5rem; }
#tts-status-text { font-size: 1.3rem; }
#item-name-display { font-size: 2rem; }
#description-container h4 { font-size: 1.5rem; }
#item-description-display { font-size: 1.3rem; }
.playback-btn svg { width: 44px; height: 44px; }
}
</style>
</head>
<body>

<div id="container">
<h1>拍圖查詢</h1>
<p id="subtitle">影張相，即刻知佢係乜嘢！</p>

<!-- 圖片上傳區域 -->
<div id="image-input-area">
<img id="image-preview" src="" alt="圖片預覽">
<div id="upload-prompt">
<svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
</svg>
<p>點擊此處選擇相片</p>
</div>
</div>
<input type="file" id="file-input" accept="image/*">
<input type="file" id="camera-input" accept="image/*" capture="environment">

<!-- 操作按鈕 -->
<div id="action-buttons">
<button id="camera-btn" class="action-btn">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/></svg>
<span>影相機</span>
</button>
<button id="query-btn" class="action-btn" disabled>開始查詢</button>
</div>

<!-- 全域自動播放開關 -->
<div id="autoplay-control-area">
<label for="tts-autoplay-checkbox" id="tts-toggle-container">
<input type="checkbox" id="tts-autoplay-checkbox" checked>
<span class="tts-icon">
<svg class="speaker-on-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
<svg class="speaker-off-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-3l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
</span>
<span id="tts-status-text">自動播放：開</span>
</label>
</div>

<!-- 結果顯示區域 -->
<div id="result-container">
<!-- 播放控制器 (已移至此處) -->
<div id="tts-playback-controls" style="display: none;">
<button id="play-pause-btn" class="playback-btn" aria-label="播放或暫停">
<!-- Play Icon -->
<svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.648c1.295.748 1.295 2.535 0 3.284L7.279 20.99c-1.25.72-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" /></svg>
<!-- Pause Icon -->
<svg class="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 00-.75.75v12c0 .414.336.75.75.75h3a.75.75 0 00.75-.75V6a.75.75 0 00-.75-.75h-3zm7.5 0a.75.75 0 00-.75.75v12c0 .414.336.75.75.75h3a.75.75 0 00.75-.75V6a.75.75 0 00-.75-.75h-3z" clip-rule="evenodd" /></svg>
</button>
<button id="replay-btn" class="playback-btn" aria-label="重新播放">
<!-- Replay Icon -->
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.18-3.185m-3.181-4.992v4.992m0 0h-4.992m4.992 0l-3.182-3.182a8.25 8.25 0 00-11.664 0l-3.18 3.185" /></svg>
</button>
</div>

<p id="item-name-display"></p>
<div id="description-container" style="display: none;">
<h4>物品資料：</h4>
<p id="item-description-display"></p>
</div>
</div>

<!-- Loading 指示器 -->
<div id="loading-indicator">請稍等，正在查詢中…</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
// --- DOM 元素 ---
const imageInputArea = document.getElementById('image-input-area');
const fileInput = document.getElementById('file-input');
const cameraInput = document.getElementById('camera-input');
const cameraBtn = document.getElementById('camera-btn');
const queryBtn = document.getElementById('query-btn');
const imagePreview = document.getElementById('image-preview');
const uploadPrompt = document.getElementById('upload-prompt');
const resultContainer = document.getElementById('result-container');
const itemNameDisplay = document.getElementById('item-name-display');
const descriptionContainer = document.getElementById('description-container');
const itemDescriptionDisplay = document.getElementById('item-description-display');
const loadingIndicator = document.getElementById('loading-indicator');
const ttsToggleCheckbox = document.getElementById('tts-autoplay-checkbox');
const ttsStatusText = document.getElementById('tts-status-text');
const playbackControls = document.getElementById('tts-playback-controls');
const playPauseBtn = document.getElementById('play-pause-btn');
const replayBtn = document.getElementById('replay-btn');

// --- 狀態變數 ---
let currentImageBase64 = null;
let fullTextForSpeech = '';
let isPaused = false;

// --- 事件監聽 ---
imageInputArea.addEventListener('click', () => fileInput.click());
cameraBtn.addEventListener('click', () => cameraInput.click());
fileInput.addEventListener('change', handleFileSelect);
cameraInput.addEventListener('change', handleFileSelect);
queryBtn.addEventListener('click', identifyObject);
ttsToggleCheckbox.addEventListener('change', handleAutoplayToggle);
playPauseBtn.addEventListener('click', handlePlayPause);
replayBtn.addEventListener('click', handleReplay);

// --- 功能函數 ---

function handleFileSelect(event) {
const file = event.target.files[0];
if (!file) return;
resetStateBeforeQuery();
loadingIndicator.textContent = '正在準備圖片…';
loadingIndicator.style.display = 'block';

resizeImage(file, 1024, 0.85, (base64) => {
currentImageBase64 = base64;
imagePreview.src = base64;
imagePreview.style.display = 'block';
uploadPrompt.style.display = 'none';
imageInputArea.classList.add('has-image');
queryBtn.disabled = false;
queryBtn.textContent = '開始查詢';
loadingIndicator.style.display = 'none';
});
}

function resizeImage(file, maxSize, quality, callback) {
const reader = new FileReader();
reader.onload = (e) => {
const img = new Image();
img.onload = () => {
let { width, height } = img;
if (width > height) {
if (width > maxSize) { height *= maxSize / width; width = maxSize; }
} else {
if (height > maxSize) { width *= maxSize / height; height = maxSize; }
}
const canvas = document.createElement('canvas');
canvas.width = width;
canvas.height = height;
const ctx = canvas.getContext('2d');
ctx.drawImage(img, 0, 0, width, height);
callback(canvas.toDataURL('image/jpeg', quality));
};
img.src = e.target.result;
};
reader.readAsDataURL(file);
}

function resetStateBeforeQuery() {
speechSynthesis.cancel();
resultContainer.classList.remove('visible');
descriptionContainer.style.display = 'none';
playbackControls.style.display = 'none';
fullTextForSpeech = '';
isPaused = false;
updatePlayPauseButton(false);
}

async function identifyObject() {
if (!currentImageBase64) return;

resetStateBeforeQuery();
queryBtn.disabled = true;
queryBtn.textContent = '查詢中…';
loadingIndicator.textContent = '請稍等，正在查詢中…';
loadingIndicator.style.display = 'block';

const promptText = `你是一個專為長者服務的物品辨識助手。請根據這張圖片，用親切、簡單、易懂的方式來辨識圖中的主要物品。你的回答必須使用繁體中文及香港粵語，並遵循以下的 JSON 格式：
{
"itemName": "呢個係：[物品的清晰中文名稱]",
"description": "[一段大約100到150字左右的物品描述。如果係食物，可以簡單講下佢嘅味道、食法或者主要成份。如果係物件，可以講下佢嘅用途。如果唔係食物或物件，有好多文字，要簡單歸納下段文字講咩。用語要簡單易明，避免使用專業術語。]"
}
請確保只回傳這個 JSON 結構，不要包含任何額外的解釋或文字。`;

const requestBody = {
model: "mirexa",
messages: [{ role: "user", content: [{ type: "text", text: promptText }, { type: "image_url", image_url: { "url": currentImageBase64 } }] }],
temperature: 0.5,
stream: false
};

try {
const response = await fetch('https://text.pollinations.ai/openai', {
method: 'POST',
headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer Jeq-UCxbpvrqUEzN' },
body: JSON.stringify(requestBody)
});
if (!response.ok) throw new Error(`伺服器回應錯誤: ${response.status}`);

const data = await response.json();
const content = data.choices?.[0]?.message?.content?.trim();
if (!content) throw new Error('無法獲取有效的回應內容。');

const jsonString = content.replace(/```json\n?|\n?```/g, '');
const parsed = JSON.parse(jsonString);
if (!parsed.itemName || !parsed.description) throw new Error('回應的資料格式不正確。');

itemNameDisplay.textContent = parsed.itemName;
itemDescriptionDisplay.textContent = parsed.description;
descriptionContainer.style.display = 'block';
resultContainer.classList.add('visible');

fullTextForSpeech = `${parsed.itemName}。 ${parsed.description}`;
if (ttsToggleCheckbox.checked) {
playbackControls.style.display = 'flex';
speak(fullTextForSpeech);
}
} catch (error) {
console.error('查詢時發生錯誤:', error);
itemNameDisplay.textContent = '查詢失敗';
itemDescriptionDisplay.textContent = '唔好意思，網路可能唔太穩定，或者張相認唔到。請檢查網路後，試下用另一張相再試一次。';
descriptionContainer.style.display = 'block';
resultContainer.classList.add('visible');
} finally {
loadingIndicator.style.display = 'none';
queryBtn.disabled = false;
queryBtn.textContent = '再查一張';
}
}

// --- TTS 相關控制函數 ---

function handleAutoplayToggle() {
if (ttsToggleCheckbox.checked) {
ttsStatusText.textContent = '自動播放：開';
} else {
ttsStatusText.textContent = '自動播放：關';
speechSynthesis.cancel();
}
}

function updatePlayPauseButton(isPlaying) {
if (isPlaying) {
playPauseBtn.classList.add('is-playing');
playPauseBtn.setAttribute('aria-label', '暫停');
} else {
playPauseBtn.classList.remove('is-playing');
playPauseBtn.setAttribute('aria-label', '播放');
}
}

function handlePlayPause() {
if (speechSynthesis.speaking && !isPaused) {
speechSynthesis.pause();
isPaused = true;
updatePlayPauseButton(false);
} else if (isPaused) {
speechSynthesis.resume();
isPaused = false;
updatePlayPauseButton(true);
} else {
speak(fullTextForSpeech);
}
}

function handleReplay() {
speechSynthesis.cancel();
speak(fullTextForSpeech);
}

function cleanText(text) {
return text
.replace(/\([^)]*\)/g, '')
.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2700}-\u{27BF}]/gu, '')
.replace(/[^\u4e00-\u9fff\u3400-\u4dbf\u20000-\u2a6df\u2a700-\u2b73f\u2b740-\u2b81f\u2b820-\u2ceaf\u2ceb0-\u2ebe0。，、；：？！""''（）〔〕【】《》〈〉…—\s]/g, '')
.trim();
}

function speak(text) {
if (!('speechSynthesis'in window) || !text) return;

speechSynthesis.cancel();
isPaused = false;
const cleanedText = cleanText(text);
if (!cleanedText) return;

const utterance = new SpeechSynthesisUtterance(cleanedText);
utterance.lang = 'zh-HK';
utterance.rate = 1.0;
utterance.pitch = 0.9;

utterance.onstart = () => {
updatePlayPauseButton(true);
};

utterance.onend = () => {
isPaused = false;
updatePlayPauseButton(false);
};

utterance.onerror = (e) => {
console.error('語音合成錯誤:', e);
isPaused = false;
updatePlayPauseButton(false);
};

speechSynthesis.speak(utterance);
}
});
</script>

<footer class="copyright-footer">
<p>Copyright © 2025 陳冠健. All rights reserved.</p>
</footer>

</body>
</html>
